# 医疗助手历史记录功能说明

## 功能概述

本项目为用户提供了完整的聊天历史记录管理功能，包括：

- **个人历史记录查看** - 用户可以查看自己的所有医疗咨询记录
- **智能筛选功能** - 支持按关键词搜索和日期范围筛选
- **数据统计** - 显示总消息数、对话次数、首次咨询时间等统计信息
- **数据导出** - 支持将历史记录导出为CSV格式文件
- **响应式设计** - 支持桌面和移动设备访问

## 文件结构

```
MedAssistant-v0/
├── history.html          # 历史记录页面
├── history.js            # 历史记录页面逻辑
├── test_history.html     # 历史记录功能测试页面
├── app.py               # 后端API（已修改）
└── chat.html            # 聊天页面（已添加历史记录入口）
```

## 后端API

### 历史记录API

**GET /api/chat/history**

获取当前用户的聊天历史记录。

**请求头：**
```
Authorization: Bearer <token>
```

**响应格式：**
```json
[
  {
    "user": "用户消息内容",
    "assistant": "助手回复内容", 
    "timestamp": "2024-01-01T12:00:00Z"
  }
]
```

## 前端功能

### 1. 历史记录页面 (history.html)

**主要功能：**
- 显示用户的所有聊天记录
- 按时间倒序排列
- 每条记录显示用户消息和助手回复
- 显示对话时间和序号

**界面元素：**
- 统计信息栏（总消息数、对话次数、首次咨询时间）
- 筛选控制栏（搜索、日期筛选、导出功能）
- 历史记录列表

### 2. 筛选功能

**搜索功能：**
- 支持关键词搜索
- 同时搜索用户消息和助手回复
- 实时搜索（输入后300ms自动筛选）

**日期筛选：**
- 支持开始日期和结束日期
- 可单独设置开始或结束日期
- 支持清除筛选条件

### 3. 导出功能

**CSV导出：**
- 导出当前筛选结果
- 包含时间、用户消息、助手回复三列
- 文件名格式：`医疗咨询记录_YYYY-MM-DD.csv`
- 支持中文编码

## 使用方法

### 1. 访问历史记录页面

在聊天页面点击"历史记录"按钮，或直接访问：
```
http://localhost:5050/history.html
```

### 2. 筛选历史记录

1. **关键词搜索**：在搜索框中输入关键词
2. **日期筛选**：设置开始日期和/或结束日期
3. **应用筛选**：点击"筛选"按钮
4. **清除筛选**：点击"清除"按钮恢复全部记录

### 3. 导出历史记录

1. 应用所需的筛选条件
2. 点击"导出"按钮
3. 浏览器会自动下载CSV文件

### 4. 测试功能

访问测试页面验证功能：
```
http://localhost:5050/test_history.html
```

## 数据存储

### 后端存储

**内存存储：**
```python
conversation_context = {}  # 当前会话上下文
```

**持久化存储：**
```python
chat_records = []  # 全局聊天记录列表
CHAT_HISTORY_FILE = 'chat_history.json'  # 存储文件
```

**数据格式：**
```json
{
  "userId": "用户名",
  "userMessage": "用户消息",
  "assistantMessage": "助手回复",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

### 前端存储

**本地存储：**
```javascript
localStorage.setItem('token', 'JWT令牌');
localStorage.setItem('userName', '用户名');
```

## 安全特性

1. **JWT认证** - 所有API调用都需要有效的JWT令牌
2. **用户隔离** - 用户只能查看自己的历史记录
3. **输入验证** - 前端和后端都有输入验证
4. **XSS防护** - 使用HTML转义防止XSS攻击

## 性能优化

1. **分页加载** - 大量数据时支持分页显示
2. **搜索防抖** - 搜索输入使用防抖优化
3. **缓存机制** - 前端缓存已加载的数据
4. **按需渲染** - 只渲染可见的历史记录

## 故障排除

### 常见问题

1. **历史记录不显示**
   - 检查用户是否已登录
   - 确认JWT令牌是否有效
   - 查看浏览器控制台错误信息

2. **API调用失败**
   - 确认后端服务器正在运行
   - 检查网络连接
   - 验证API端点是否正确

3. **导出功能不工作**
   - 确认浏览器支持Blob API
   - 检查是否有足够的记录可导出
   - 查看浏览器下载设置

### 调试方法

1. **使用测试页面**：访问 `test_history.html` 进行功能测试
2. **查看控制台**：打开浏览器开发者工具查看错误信息
3. **检查网络**：在开发者工具的Network标签页查看API请求
4. **后端日志**：查看Flask服务器的控制台输出

## 扩展功能

### 可能的改进

1. **分页功能** - 支持大量历史记录的分页显示
2. **高级搜索** - 支持正则表达式和模糊搜索
3. **标签系统** - 为对话添加标签进行分类
4. **数据可视化** - 添加图表显示使用统计
5. **备份恢复** - 支持历史记录的备份和恢复
6. **多格式导出** - 支持PDF、Word等格式导出

### 技术栈

- **后端**：Flask + Python
- **前端**：原生JavaScript + HTML5 + CSS3
- **存储**：JSON文件存储
- **认证**：JWT令牌
- **API**：RESTful API设计

## 更新日志

### v1.0.0 (当前版本)
- ✅ 基础历史记录查看功能
- ✅ 关键词搜索功能
- ✅ 日期范围筛选
- ✅ CSV导出功能
- ✅ 响应式设计
- ✅ 统计信息显示
- ✅ 安全认证机制 